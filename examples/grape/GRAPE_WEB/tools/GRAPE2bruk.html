
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
 <title>Filename : GRAPE2bruk</title>
      <meta name="generator" content="MATLAB 7.14">
      <link rel="schema.DC" href="http://purl.org/dc/elements/1.1/">
      <meta name="DC.date" content="2014-03-05">
      <meta name="DC.source" content="GRAPE2bruk.m">
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
      <link rel="stylesheet" type="text/css" href="../css/screen.css" media="screen" />
  </head>
  
<body>
    <ul id=menu>
      <li><a href="../flowchart.html">Flow Chart</a>
      <li><a href="../tools/tools.html">Tools</a>
      <li><a href="../faq/faq.html">F. A. Q.</a>
      <li><a href="../../index.html">NMR-QIP Page</a>
    </ul>
    <div class="content"><h1>FileName : cutfreq</h1><!--introduction--><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#1">Description</a></li><li><a href="#2">Command</a></li></ul></div><h2>Description<a name="1"></a></h2><p>Converts the GRAPE pulse to the bruker readable format.</p><h2>Command<a name="2"></a></h2><p><b>GRAPE2bruk(GRinfo,puls_length,GRAPE_name,GRAPE_ext,FileOpt)</b></p><p><b>GRinfo</b> : Variable in which all the information of grape pulse is stored.</p><p><b>puls_length</b> : length of the calibirated pi/2 pulse, input as a matrix for multiple nuclei. <b>Caution : input according to spinlist of the GRAPE pulse</b></p><p><b>GRAPE_name</b> : Name of the bruker shape file you would like to be named as. Default is the GRAPEname provided in the inputfile.</p><p><b>GRAPE_ext</b> : Extension of the bruker shape file you would like to named as. Default is '.GRP'.</p><p><b>FiliOpt</b> : Option for overwriting the file, input 'o' for overwriting. Default is set to not to overwrite</p><p><b>NOTE: The files are stored in the folder named Bruker_Output with the name and extension provided in the input</b></p><pre class="codeinput"><span class="keyword">function</span> GRAPE2bruk(GRinfo,puls,GRAPE_name,GRAPE_ext,FileOpt)
<span class="keyword">global</span> gra
gra=GRinfo;
spinlist=gra.spinlist;

<span class="comment">%%%%%%%%%%%%% DEFINING DEFAULTS %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span class="keyword">if</span> (nargin &lt; 3 || isempty(GRAPE_name)); GRAPE_name = gra.GRAPEname; <span class="keyword">end</span>;
<span class="keyword">if</span> (nargin &lt; 4 || isempty(GRAPE_ext)); GRAPE_ext = <span class="string">'GRP'</span>; <span class="keyword">end</span>;
<span class="keyword">if</span> (nargin &lt; 5 || isempty(FileOpt)); FileOpt = <span class="string">'n'</span>; <span class="keyword">end</span>;



amp=cell(1,length(spinlist)); phi=cell(1,length(spinlist));
scaled_amp=cell(1,length(spinlist));
N1=cell(1,length(spinlist)); B2=cell(1,length(spinlist));
B1=cell(1,length(spinlist)); N2=cell(1,length(spinlist));

<span class="keyword">for</span> k=1:length(spinlist)
        amp{k}=sqrt((gra.u(:,k)/(2*pi)).^2 + (gra.u(:,k+length(spinlist))/(2*pi)).^2);
        scaled_amp{k}=amp{k}*100/(1/4/puls(k));
        <span class="keyword">for</span> n=1:length(gra.u)
            <span class="keyword">if</span> scaled_amp{k}(n)&lt;0.00001
                N1{k}(n)=1;
                B1{k}(n)=0;
            <span class="keyword">else</span>
                N1{k}(n)=1+floor(log10(scaled_amp{k}(n)));
                B1{k}(n)=scaled_amp{k}(n)./(10.^(N1{k}(n)-1));
            <span class="keyword">end</span>
        <span class="keyword">end</span>

        phi{k}=(atan2(gra.u(:,k+length(spinlist)),gra.u(:,k)));

<span class="comment">%%%%%%%%%%% MAKING BRUKER COMPATIBLE %%%%%%%%%%%%%%%%%</span>

<span class="comment">%         phi{k}=mod((pi-phi{k}),2*pi);</span>

<span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>

<span class="comment">%%%%%%%%%%%%%% ACTUAL CONVERSION  %%%%%%%%%%%%%%%%%%%%</span>
        <span class="keyword">for</span> n=1:length(phi{k})
            <span class="keyword">if</span> phi{k}(n)&lt;0
               phi{k}(n) = phi{k}(n)+2*pi;
            <span class="keyword">end</span>
        <span class="keyword">end</span>
<span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
        phi{k}=phi{k}*180/pi;
       <span class="keyword">for</span> n=1:length(gra.u)
            <span class="keyword">if</span> phi{k}(n)&lt;0.00001
                N2{k}(n)=1;
                B2{k}(n)=0;
            <span class="keyword">else</span>
                N2{k}(n)=1+floor(log10(sign(phi{k}(n)).*phi{k}(n)));
                B2{k}(n)=phi{k}(n)./(10.^(N2{k}(n)-1));
            <span class="keyword">end</span>
       <span class="keyword">end</span>
<span class="keyword">end</span>

chlist    = [<span class="string">'ABCDEFGHIJKLMNOPQRSTUVWXYZ'</span>];



<span class="keyword">for</span> k=1:length(spinlist)
    <span class="keyword">if</span> (k == 1 &amp;&amp; length(spinlist)==1);
        chname = [];
    <span class="keyword">else</span>
        chname = [<span class="string">'_'</span> num2str(length(spinlist)) chlist(k)];
    <span class="keyword">end</span>;
    fileName = [GRAPE_name chname <span class="string">'.'</span> GRAPE_ext];

<span class="comment">%%%%%%%%%%%%%%%% CHECKING TO PREVENT OVERWRITING FILE %%%%%%%%%%%%%</span>
    <span class="keyword">if</span> FileOpt == <span class="string">'n'</span>
         filexist = 0;
         <span class="keyword">if</span> exist(fileName,<span class="string">'file'</span>) == 2
            filexist = 1;
         <span class="keyword">end</span>
         <span class="keyword">while</span> filexist &gt; 0;
            fileName = [GRAPE_name chname num2str(filexist) <span class="string">'.'</span> GRAPE_ext];
            <span class="keyword">if</span> exist(fileName,<span class="string">'file'</span>) == 2
               filexist = filexist + 1;
            <span class="keyword">else</span>
               filexist = 0;
            <span class="keyword">end</span>
         <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>


    fileAddr = [<span class="string">'Bruker_Output'</span> filesep fileName];
    pname = gra.gate;
    minx = min(scaled_amp{k});
    maxx = max(scaled_amp{k});
    miny = min(phi{k});
    maxy = max(phi{k});
    average_power = sum(scaled_amp{k})/length(scaled_amp{k});
    currnt_time=clock;
    fid = fopen(fileAddr,<span class="string">'w'</span>);
    fprintf(fid,<span class="string">'##TITLE= %s \n'</span>,fileName);
    fprintf(fid,<span class="string">'##$PULSE_NAME= %s\n'</span>,pname);
    fprintf(fid,<span class="string">'##JCAMP-DX= 5.00 Bruker JCAMP library \n'</span>);
    fprintf(fid,<span class="string">'##DATA TYPE= Shape Data \n'</span>);
    fprintf(fid,<span class="string">'##ORIGIN= GRAPE \n'</span>);
    fprintf(fid,<span class="string">'##OWNER= &lt;guest&gt; \n'</span>);
    fprintf(fid,<span class="string">'##DATE= %s \n'</span>,date);
    fprintf(fid,<span class="string">'##TIME(HH/MM/SS)= %g:%g:%0.0f \n'</span>,currnt_time(4),currnt_time(5),currnt_time(6));
    fprintf(fid,<span class="string">'##$SHAPE_PARAMETERS= Type: SMP ; Amplitude: 100 \n'</span>);
    fprintf(fid,<span class="string">'##--------- SMP PARAMETERS ---------\n'</span>);
    fprintf(fid,<span class="string">'##Total_Duration = %5.2f us \n'</span>,gra.T*1e6);
    fprintf(fid,<span class="string">'##Initial_Delay = %5.2f us \n'</span>,gra.initdelay*1e6);
    fprintf(fid,<span class="string">'##Ending_Delay =%5.2f us \n'</span>,gra.initdelay*1e6);
    fprintf(fid,<span class="string">'##Maximum_Amplitude =%g kHz \n'</span>,(1/4/puls(k))*1e-3);
    fprintf(fid,<span class="string">'##Transmitter_Offset = %g Hz \n'</span>,0.00);
    fprintf(fid,<span class="string">'##----------------------------------\n'</span>);
    fprintf(fid,<span class="string">'##MINX= %1.6e \n'</span>,minx);
    fprintf(fid,<span class="string">'##MAXX= %1.6e \n'</span>,maxx);
    fprintf(fid,<span class="string">'##MINY= %1.6e \n'</span>,miny);
    fprintf(fid,<span class="string">'##MAXY= %1.6e \n'</span>,maxy);
    fprintf(fid,<span class="string">'##AVG POWER= %1.6e \n'</span>,average_power);
    fprintf(fid,<span class="string">'##$SHAPE_EXMODE= Excitation \n'</span>);
    fprintf(fid,<span class="string">'##$SHAPE_TOTROT= 9.000000e+01 \n'</span>);
    fprintf(fid,<span class="string">'##$SHAPE_BWFAC= 1.116000e+00 \n'</span>);
    fprintf(fid,<span class="string">'##$SHAPE_INTEGFAC= 1.000000e+00 \n'</span>);
    fprintf(fid,<span class="string">'##$SHAPE_MODE= 1 \n'</span>);
    fprintf(fid,<span class="string">'##NPOINTS= %g \n'</span>,gra.N);
    fprintf(fid,<span class="string">'##XYPOINTS= (XY..XY) \n'</span>);

    <span class="keyword">for</span> j=1:length(gra.u)
        fprintf(fid,<span class="string">'%5.4fE%0.2i, %5.4fE%0.2i\n'</span>,B1{k}(j),N1{k}(j)-1,B2{k}(j),N2{k}(j)-1);
    <span class="keyword">end</span>
    fprintf(fid,<span class="string">'##END='</span>);
    fclose(fid);

    disp([<span class="string">'    The shape file is saved as '</span> fileAddr]);
    disp(<span class="string">'   -------------------------------------------------'</span>)
    disp(<span class="string">'   '</span>)
    <span class="keyword">if</span> (maxx &gt; 100)
        disp(<span class="string">'Maximum power is more than 100'</span>)
    <span class="keyword">end</span>
<span class="keyword">end</span>
</pre><p class="footer"><br>
      Published with MATLAB&reg; 7.14<br></p></div><!--
##### SOURCE BEGIN #####
%% FileName : cutfreq

%% Description
% Converts the GRAPE pulse to the bruker readable format.

%% Command
% *GRAPE2bruk(GRinfo,puls_length,GRAPE_name,GRAPE_ext,FileOpt)*
%
% *GRinfo* : Variable in which all the information of grape pulse is stored.
%
% *puls_length* : length of the calibirated pi/2 pulse, input as a matrix for
% multiple nuclei. *Caution : input according to spinlist of the GRAPE pulse* 
%
% *GRAPE_name* : Name of the bruker shape file you would like to be named as.
% Default is the GRAPEname provided in the inputfile.
%
% *GRAPE_ext* : Extension of the bruker shape file you would like to named
% as. Default is '.GRP'.
% 
% *FiliOpt* : Option for overwriting the file, input 'o' for overwriting.
% Default is set to not to overwrite
%
%
% *NOTE: The files are stored in the folder named Bruker_Output with the name and extension provided in the input*


function GRAPE2bruk(GRinfo,puls,GRAPE_name,GRAPE_ext,FileOpt)

if nargin<1
    disp('  ')
    disp('      GRAPE2bruk(GRinfo,[P1 P2],''GRAPE_name'',''GRAPE_ext'',''FileOpt'')')
    disp('      Makes BRUKER shape pulsea for the simulated gate')
    disp('  ')
    disp('                     P1,P2 - Time for 90 deg pulse in seconds for nuclei supplied according to spinlist')
    disp('  ')
    disp('            ''GRAPE_name'' - Name for shape file {default is the GRAPEname provided in inputfile}')
    disp(' ')
    disp('             ''GRAPE_ext'' - extenstion for shape file e.g. ''.abc''')
    disp('                                    {default : ''.GRP''}           ')
    disp(' ')
    disp('               ''FileOpt'' - Overwrite or save as a new file?')
    disp('                              ''n'' [for new] / ''o'' [for overwrite] (default ''n''). ')
    disp('                              The output filename is ''GRAPEnameK.mat'', where K is automatically')
    disp('                              selected unless overwriting is opted and GRAPEname is provided in the inputfile') 
    disp(' ')
    disp('      SIMPLEST INPUT : GRAPE2bruk(GRinfo,[P1 P2],[],[])')
    disp('')
    disp('  ')
    disp('   It is unnecessary to provide all the inputs.  Empty inputs indicate')
    disp('   indicate default selections.')
    disp('  ')
    disp('   (Hemant Katiyar, 2012)')
    return
end
 
global gra
gra=GRinfo; 
spinlist=gra.spinlist;

%%%%%%%%%%%%% DEFINING DEFAULTS %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
if (nargin < 3 || isempty(GRAPE_name)); GRAPE_name = gra.GRAPEname; end;
if (nargin < 4 || isempty(GRAPE_ext)); GRAPE_ext = 'GRP'; end;
if (nargin < 5 || isempty(FileOpt)); FileOpt = 'n'; end;



amp=cell(1,length(spinlist)); phi=cell(1,length(spinlist));
scaled_amp=cell(1,length(spinlist));
N1=cell(1,length(spinlist)); B2=cell(1,length(spinlist));
B1=cell(1,length(spinlist)); N2=cell(1,length(spinlist));

for k=1:length(spinlist)
        amp{k}=sqrt((gra.u(:,k)/(2*pi)).^2 + (gra.u(:,k+length(spinlist))/(2*pi)).^2);
        scaled_amp{k}=amp{k}*100/(1/4/puls(k));
        for n=1:length(gra.u)
            if scaled_amp{k}(n)<0.00001
                N1{k}(n)=1;
                B1{k}(n)=0;
            else
                N1{k}(n)=1+floor(log10(scaled_amp{k}(n)));
                B1{k}(n)=scaled_amp{k}(n)./(10.^(N1{k}(n)-1));
            end
        end

        phi{k}=(atan2(gra.u(:,k+length(spinlist)),gra.u(:,k)));

%%%%%%%%%%% MAKING BRUKER COMPATIBLE %%%%%%%%%%%%%%%%%

%         phi{k}=mod((pi-phi{k}),2*pi);
        
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%% ACTUAL CONVERSION  %%%%%%%%%%%%%%%%%%%%
        for n=1:length(phi{k})
            if phi{k}(n)<0
               phi{k}(n) = phi{k}(n)+2*pi;
            end
        end
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
        phi{k}=phi{k}*180/pi;
       for n=1:length(gra.u)
            if phi{k}(n)<0.00001
                N2{k}(n)=1;
                B2{k}(n)=0;
            else
                N2{k}(n)=1+floor(log10(sign(phi{k}(n)).*phi{k}(n)));
                B2{k}(n)=phi{k}(n)./(10.^(N2{k}(n)-1));
            end
       end
end

chlist    = ['ABCDEFGHIJKLMNOPQRSTUVWXYZ'];



for k=1:length(spinlist)
    if (k == 1 && length(spinlist)==1); 
        chname = []; 
    else
        chname = ['_' num2str(length(spinlist)) chlist(k)]; 
    end;
    fileName = [GRAPE_name chname '.' GRAPE_ext];
    
%%%%%%%%%%%%%%%% CHECKING TO PREVENT OVERWRITING FILE %%%%%%%%%%%%%
    if FileOpt == 'n'
         filexist = 0;
         if exist(fileName,'file') == 2
            filexist = 1;
         end
         while filexist > 0; 
            fileName = [GRAPE_name chname num2str(filexist) '.' GRAPE_ext];
            if exist(fileName,'file') == 2
               filexist = filexist + 1;
            else
               filexist = 0;
            end
         end
    end
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

    
    fileAddr = ['Bruker_Output' filesep fileName];
    pname = gra.gate;
    minx = min(scaled_amp{k});
    maxx = max(scaled_amp{k});
    miny = min(phi{k});
    maxy = max(phi{k});
    average_power = sum(scaled_amp{k})/length(scaled_amp{k});
    currnt_time=clock;
    fid = fopen(fileAddr,'w');
    fprintf(fid,'##TITLE= %s \n',fileName);
    fprintf(fid,'##$PULSE_NAME= %s\n',pname);
    fprintf(fid,'##JCAMP-DX= 5.00 Bruker JCAMP library \n');
    fprintf(fid,'##DATA TYPE= Shape Data \n');
    fprintf(fid,'##ORIGIN= GRAPE \n');
    fprintf(fid,'##OWNER= <guest> \n');
    fprintf(fid,'##DATE= %s \n',date);
    fprintf(fid,'##TIME(HH/MM/SS)= %g:%g:%0.0f \n',currnt_time(4),currnt_time(5),currnt_time(6));
    fprintf(fid,'##$SHAPE_PARAMETERS= Type: SMP ; Amplitude: 100 \n');
    fprintf(fid,'##REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH- SMP PARAMETERS REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-\n');
    fprintf(fid,'##Total_Duration = %5.2f us \n',gra.T*1e6);
    fprintf(fid,'##Initial_Delay = %5.2f us \n',gra.initdelay*1e6);
    fprintf(fid,'##Ending_Delay =%5.2f us \n',gra.initdelay*1e6);
    fprintf(fid,'##Maximum_Amplitude =%g kHz \n',(1/4/puls(k))*1e-3);
    fprintf(fid,'##Transmitter_Offset = %g Hz \n',0.00);
    fprintf(fid,'##REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH\n');
    fprintf(fid,'##MINX= %1.6e \n',minx);
    fprintf(fid,'##MAXX= %1.6e \n',maxx);
    fprintf(fid,'##MINY= %1.6e \n',miny);
    fprintf(fid,'##MAXY= %1.6e \n',maxy);
    fprintf(fid,'##AVG POWER= %1.6e \n',average_power);
    fprintf(fid,'##$SHAPE_EXMODE= Excitation \n');
    fprintf(fid,'##$SHAPE_TOTROT= 9.000000e+01 \n');
    fprintf(fid,'##$SHAPE_BWFAC= 1.116000e+00 \n');
    fprintf(fid,'##$SHAPE_INTEGFAC= 1.000000e+00 \n');
    fprintf(fid,'##$SHAPE_MODE= 1 \n');
    fprintf(fid,'##NPOINTS= %g \n',gra.N);
    fprintf(fid,'##XYPOINTS= (XY..XY) \n');

    for j=1:length(gra.u)
        fprintf(fid,'%5.4fE%0.2i, %5.4fE%0.2i\n',B1{k}(j),N1{k}(j)-1,B2{k}(j),N2{k}(j)-1);
    end
    fprintf(fid,'##END=');
    fclose(fid);
    
    disp(['    The shape file is saved as ' fileAddr]);
    disp('   REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-')
    disp('   ')
    if (maxx > 100)
        disp('Maximum power is more than 100')
    end
end



##### SOURCE END #####
--></body></html>