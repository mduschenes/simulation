
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
      <title>Filename : rungrape</title>
      <meta name="generator" content="MATLAB 7.14">
      <link rel="schema.DC" href="http://purl.org/dc/elements/1.1/">
      <meta name="DC.date" content="2014-03-05">
      <meta name="DC.source" content="rungrap.m">
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
      <link rel="stylesheet" type="text/css" href="css/screen.css" media="screen" />
  </head>
  
<body>
    <ul id=menu>
      <li><a href="flowchart.html">Flow Chart</a>
      <li><a href="tools/tools.html">Tools</a>
      <li><a href="faq/faq.html">F. A. Q.</a>
      <li><a href="../index.html">NMR-QIP Page</a>
    </ul>
    <div class="content"><h1>FileName : rungrape</h1><!--introduction--><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#1">Description</a></li><li><a href="#3">Declaring Global Variables</a></li><li><a href="#4">Declaring Default Inputs</a></li><li><a href="#5">Initialization of Input Parameters</a></li><li><a href="#6">Checking the disk to prevent overwriting</a></li><li><a href="#7">Penalty Funcion</a></li><li><a href="#8">Main Program</a></li><li><a href="#9">Saving after the program has finished</a></li><li><a href="#10">Printing Results</a></li></ul></div><h2>Description<a name="1"></a></h2><p>Main file which executes all the other files</p><pre class="codeinput"><span class="keyword">function</span> GRinfo = rungrape(InputName,div,askplot,FileOpt)

</pre><h2>Declaring Global Variables<a name="3"></a></h2><pre class="codeinput">clc
clear <span class="string">global</span>
tic;
<span class="keyword">global</span> gra
</pre><h2>Declaring Default Inputs<a name="4"></a></h2>
div controls the shape of penalty function, for more details see <a href="penalty.html">penalty </a>.
<pre class="codeinput">
<span class="keyword">if</span> (nargin &lt; 2 || isempty(div)); div = 5    ; <span class="keyword">end</span>;
</pre>
askplot controls whether you want to see the shape of the <a href="penalty.html">penalty </a> function or not.
<pre class="codeinput">
<span class="keyword">if</span> (nargin &lt; 3 || isempty(askplot)); askplot = <span class="string">'n'</span>; <span class="keyword">end</span>;
</pre>
 FileOpt controls the overwriting of file.
 <pre class="codeinput">
<span class="keyword">if</span> (nargin &lt; 4 || isempty(FileOpt)); FileOpt = <span class="string">'n'</span>; <span class="keyword">end</span>;
</pre>

<h2>Initialization of Input Parameters<a name="5"></a></h2>
Getting the values written in input file, check matlab inbuilt function <a href="http://www.mathworks.in/help/matlab/ref/eval.html" target="blank">eval</a> for more details
<pre class="codeinput">
eval(InputName);
</pre>
Making v=chemical shits and J=J-coupling values global
<pre class="codeinput">
gra.v=v;
gra.J=J;
</pre>
Finding out number of spins, check <a href="prodop.html">prodop</a> for more details
<pre class="codeinput">
gra.nspins = sum(gra.spinlist);
</pre>
Generating basis operators
<pre class="codeinput">
[gra.Ix,gra.Iy,gra.Iz,~,~,~,sIHz] = prodop(gra.spinNumbers,gra.spinlist);
</pre>
<a href="generate_free_evolH.html">Generating free-Evolution Hamiltonian</a>
<pre class="codeinput">
gra.Hint = generate_free_evolH(gra.spinlist,v,J);
</pre>
<a href="generate_rfH.html">Generation RF Hamiltonian</a>
<pre class="codeinput">
gra.Hrf = generate_rfH(gra.spinlist);
</pre>
Total time of the sequence
<pre class="codeinput">
gra.T=gra.del_t*gra.N;
</pre>
Negative Evolution Unitary [link]
<pre class="codeinput">
gra.Ud = expm(1i*gra.Hint*gra.initdelay);
</pre>
Unitary for which GRAPE will be optimized [link]
<pre class="codeinput">
gra.U_target = gra.Ud*gra.Utarg*gra.Ud;
</pre>

<h2>Checking the disk to prevent overwriting<a name="6"></a></h2>
Defining the name to be checked as fileName
<pre class="codeinput">
fileName = [gra.GRAPEname <span class="string">'.mat'</span>];
gra.struct_name = gra.GRAPEname;
</pre>
The following loops run only if the value of FileOpt is 'n', for more clarification refer to matlab inbuilt function - <a href="http://www.mathworks.in/help/matlab/ref/exist.html" target="blank">exist</a>. 
The file iteratively checks if there is a file with input name OR input 
name with a number in front of it. the loop stops when it files that the 
file with the input name or input name with a number in front does not exist.
<pre class="codeinput">
<span class="keyword">if</span> FileOpt == <span class="string">'n'</span>
     filexist = 0;
     <span class="keyword">if</span> exist(fileName,<span class="string">'file'</span>) == 2
        filexist = 1;
     <span class="keyword">end</span>
     <span class="keyword">while</span> filexist &gt; 0;
        fileName = [gra.GRAPEname num2str(filexist) <span class="string">'.mat'</span>];
        gra.struct_name = [gra.GRAPEname num2str(filexist)];           
        <span class="keyword">if</span> exist(fileName,<span class="string">'file'</span>) == 2
           filexist = filexist + 1;
        <span class="keyword">else</span>
           filexist = 0;
        <span class="keyword">end</span>
     <span class="keyword">end</span>
<span class="keyword">end</span>
gra.GRAPEname = gra.struct_name;
</pre><h2>Penalty Funcion<a name="7"></a></h2><p>Generates a penalty profile, check <a href="penalty.html">penalty</a> for details.</p><pre class="codeinput">[gra.uprange,exitflag]= penalty(div,plength,askplot);
<span class="keyword">if</span> exitflag
    <span class="keyword">return</span>
<span class="keyword">end</span>
</pre>
Penalize the guess controls generated in previous step, check <a href="penalizecontrols.html">penalizecontrols</a> for more details.
<pre class="codeinput">
u=penalizecontrols(u);
</pre><h2>Main Program<a name="8"></a></h2><pre class="codeinput"><span class="comment">% Prints the logo saved in the file named logo_grape</span>
logo_grape()

<span class="comment">% Check calculate_robustfidelity for details</span>
[Fid P X] = calculate_robustfidelity(u);
gra.F(1)=Fid;
counter=0;
n=0;

<span class="comment">% Printing Initial things</span>
fprintf(<span class="string">'-------------------------------------------------------\n'</span>)
fprintf(<span class="string">'       Current Fidelity           Iteration            \n'</span>)
fprintf(<span class="string">'       Target =  %g                    \n'</span>,targ_fide)
fprintf(<span class="string">'       Guess Fid = %0.6f \n'</span>,Fid)
fprintf(<span class="string">'-------------------------------------------------------\n'</span>)

<span class="comment">% making epsilon global, to know more about epsilon read Khaneja's Paper</span>
gra.ep(1)=epsilon;

<span class="comment">% to be defined</span>
gra.mfa(1)=1;

<span class="comment">% al is used to store the reason why the program terminated will be clear</span>
<span class="comment">% in a moment, please continue reading</span>
al=2;

<span class="keyword">while</span> (Fid &lt;targ_fide)
    counter=counter+1;
    <span class="comment">% We calculate the new controls and new step size using the maximize_robustfidelity,</span>
    <span class="comment">% check maximise_robustfidelity for more details.</span>
    [epsilon u skip_calc_fidelity U X]=maximise_robustfidelity(P,X,u,epsilon,counter,Fid);
    <span class="comment">% checking if the epsilon value is 0 or 2 then no need to calculate the</span>
    <span class="comment">% matrix exponents again, the saved ones from previos steps are used.</span>
    <span class="comment">% if epsilon not equal to 0 or 2 then the fidelity value is calculated</span>
    <span class="comment">% using calculate_robustfidelity, check the program for more details.</span>
    gra.ep(counter)=epsilon;
    <span class="keyword">if</span> skip_calc_fidelity==1
        [Fid P X] = calculate_robustfidelity_exp_not_needed(U,X);
    <span class="keyword">else</span>
        [Fid P X] = calculate_robustfidelity(u);
    <span class="keyword">end</span>
    <span class="comment">% printing the fidelity after every 10 iterations</span>
    <span class="keyword">if</span>(mod(counter,10)==0)
        fprintf(<span class="string">'  %20.6f  %14g \n'</span>,Fid,counter)
    <span class="keyword">end</span>
    gra.F(counter+1)=Fid;
    <span class="comment">% Checking if the current fidelity is greater than the saving_fidel</span>
    <span class="comment">% which is specified in the input file. If yes, then we start saving</span>
    <span class="comment">% the control parameters.</span>
    <span class="keyword">if</span>(gra.F(counter)&gt;saving_fidel)
        <span class="keyword">if</span>(mod(n,iter_no)==0)
            gra.u=u;
            <span class="comment">% calculate_fidelity calculates fidelity in the absence of RF</span>
            <span class="comment">% inhomogenity.</span>
            [gra.IDEALfidelity X1] = calculate_fidelity(u);
            gra.Usim=X1(:,:,gra.N+1);
            gra.RFfidelity = gra.F(length(gra.F));
            GRinfo = saveGRstr(gra);
            fprintf(<span class="string">'\t\t DATA SAVED IN save_structure/%s\n'</span>,gra.struct_name)
        <span class="keyword">end</span>
        n=n+1;
    <span class="keyword">end</span>
    <span class="comment">% checking if the fidelity is increasing at least by the value</span>
    <span class="comment">% specified in gra.threshold in stop_counter iterations. Both values</span>
    <span class="comment">% are specified in the input file</span>
    <span class="keyword">if</span> (counter&gt;stop_counter &amp;&amp; gra.F(counter)-gra.F(counter-stop_counter)&lt;gra.threshold)
        al=1;
        <span class="keyword">break</span>
    <span class="keyword">end</span>
    al=2;
<span class="keyword">end</span>
</pre><h2>Saving after the program has finished<a name="9"></a></h2><pre class="codeinput">gra.u=u;
[gra.IDEALfidelity X1] = calculate_fidelity(u);
gra.Usim=X1(:,:,gra.N+1);
gra.RFfidelity = gra.F(length(gra.F));
GRinfo =saveGRstr(gra);
plotGRAPE(GRinfo)

gra.reason = {<span class="string">'Fidelity Not Improving'</span>,<span class="string">'Target Fidelity Reached'</span>};
</pre><h2>Printing Results<a name="10"></a></h2><pre class="codeinput">clc

<span class="comment">% time for which the program ran, check matalab inbuilt function <a href="http://www.mathworks.in/help/matlab/ref/tic.html" target="blank">tic toc</a></span>
<span class="comment">% for more details</span>
e = toc;

<span class="comment">% Print Logo</span>
logo_grape()

<span class="comment">% Printing rest of the results, check matlab inbuilt function <a href="http://www.mathworks.in/help/matlab/ref/fprintf.html" target="blank">fprintf</a> for</span>
<span class="comment">% more details</span>
fprintf(<span class="string">'-------------------------------------------------------\n'</span>)
fprintf(<span class="string">'Termination Reason : %s \n'</span>,gra.reason{al})
fprintf(<span class="string">' Target Fidelity  : %g\n'</span>,targ_fide )
fprintf(<span class="string">'Fidelity Reached : %g\n '</span>,gra.RFfidelity)
fprintf(<span class="string">'Fideliey of Usim : %g\n '</span>,gra.IDEALfidelity)
fprintf(<span class="string">'Time Taken\t\t  : %g seconds\n '</span>,e)
fprintf(<span class="string">'Iterations\t\t  : %g\n'</span>,counter)
fprintf(<span class="string">'-------------------------------------------------------\n'</span>)
fprintf(<span class="string">'DATA SAVED IN save_structure/%s\n'</span>,GRinfo.struct_name)
</pre><p class="footer"><br>
      Published with MATLAB&reg; 7.14<br></p></div>
      
 </body></html>