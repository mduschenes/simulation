#!/bin/bash

# Setup variables

# Environment Name
env=${1:-jax}

# Paths
pkgs=/pkgs/anaconda3
envs=${HOME}/env

channels=(intel conda-forge)
requirements=requirements.txt


# Setup paths

mkdir -p ${envs}

export PATH=${pkgs}/bin:${PATH}
export LD_LIBRARY_PATH=${pkgs}/lib:${LD_LIBRARY_PATH}
export PYTHONPATH=${envs}/${env}:$PYTHONPATH


# Setup conda

__conda_setup="$('${pkgs}/bin/conda' 'shell.bash' 'hook' 2> /dev/null)"
if [ $? -eq 0 ]; then
    eval "$__conda_setup"
else
    if [ -f "${pkgs}/etc/profile.d/conda.sh" ]; then
        . "${pkgs}/etc/profile.d/conda.sh"
    else
        export PATH="${pkgs}/bin:$PATH"
    fi
fi
unset __conda_setup

export -f conda
export -f __conda_activate
export -f __conda_reactivate
export -f __conda_hashr	
export -f __add_sys_prefix_to_path


# Create env

conda deactivate
	
conda config --remove envs_dirs ${envs} &>/dev/null 2>&1
conda config --append envs_dirs ${envs} &>/dev/null 2>&1

conda remove --name ${env} --all

conda create --prefix ${envs}/${env}


# Activate environment
# conda activate ${env}
source activate ${envs}/${env}

# Install packages

conda install --file ${requirements} --channel ${channels[0]} --channel ${channels[1]}


